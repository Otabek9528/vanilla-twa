<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prayer Times App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="text-align: center; margin-top: 50px; font-family: sans-serif;">
  <img src="assets/tapps.png" width="64" alt="logo" />
  <h1>Namoz Vaqtlari</h1>
  <p>üìçLokatsiyangiz asosida namoz vaqtlari aniqlanadi</p>

  <script>
    Telegram.WebApp.ready();

    // Set main button text and show it
    Telegram.WebApp.MainButton.setText("Namoz vaqtlarini ko‚Äòrish");
    Telegram.WebApp.MainButton.show();

    // Location will be stored here after user grants access
    let userLocation = null;

    // Ask for location access
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        console.log("Location retrieved:", userLocation);
      },
      (error) => {
        Telegram.WebApp.showAlert("‚ùå Lokatsiyani olish imkoni bo‚Äòlmadi. Iltimos, ruxsat bering.");
        console.error("Location error:", error);
      }
    );

    // Main Button click: fetch and show prayer times
    Telegram.WebApp.MainButton.onClick(async () => {
      if (!userLocation) {
        Telegram.WebApp.showAlert("‚ùå Lokatsiya aniqlanmagan. Iltimos, qayta urinib ko‚Äòring.");
        return;
      }

      const { latitude, longitude } = userLocation;
      const method = 3; // Muslim World League
      const school = 1; // Hanafiy

      try {
        const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=${method}&school=${school}`);
        const data = await res.json();

        if (!data || !data.data || !data.data.timings) {
          throw new Error("No data from API");
        }

        const t = data.data.timings;
        const formatted = `
<b>Namoz vaqtlari</b>:
Bomdod: ${t.Fajr}
Quyosh: ${t.Sunrise}
Peshin: ${t.Dhuhr}
Asr: ${t.Asr}
Shom: ${t.Maghrib}
Xufton: ${t.Isha}
        `.trim();

        Telegram.WebApp.showAlert(formatted, {parse_mode: "HTML"});
      } catch (error) {
        console.error(error);
        Telegram.WebApp.showAlert("‚ùå Namoz vaqtlari olinmadi. Internetni tekshirib ko‚Äòring.");
      }
    });
  </script>
</body>
</html>
