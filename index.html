<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prayer Times App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="prayer-panel">
    <div class="location-bar">
      <span class="location-icon">ğŸ“</span>
      <span id="cityName">Joy aniqlanmoqda...</span>
    </div>

    <h2 class="panel-title">Namoz vaqtlari</h2>
    <p class="panel-date" id="uzbekDate">--</p>

    <div class="prayer-grid-modern" id="prayerGrid">
      <!-- Populated dynamically -->
    </div>

    <div class="sun-panel" id="sunPanel">
      <!-- Sunrise / Sunset dynamically inserted -->
    </div>

    <div class="spoiler-info">
      <p>
        <b>Namoz vaqtlari Muslim World League</b> usuli orqali hisoblandi.<br>
        Ehtiyot choralari:<br>
        â€¢ <b>Saharlikni</b> Bomdoddan âˆ’5 daqiqa avval,<br>
        â€¢ <b>Iftorlikni</b> Shomdan +5 daqiqa keyin,<br>
        â€¢ <b>Namozlarni</b> +10 daqiqa keyin ado etish tavsiya etiladi.
      </p>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();

    async function getCityName(lat, lon) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=uz`);
        const data = await res.json();
        return data.address.city || data.address.town || data.address.village || "Nomaâ€™lum joy";
      } catch {
        return "Nomaâ€™lum joy";
      }
    }

    async function getPrayerTimes(lat, lon, method = 3, madhab = 1) {
      const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=${method}&school=${madhab}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.data;
    }

    function getUzbekDate() {
      const months = ["Yanvar", "Fevral", "Mart", "Aprel", "May", "Iyun", "Iyul", "Avgust", "Sentabr", "Oktabr", "Noyabr", "Dekabr"];
      const d = new Date();
      return `${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function renderPrayerTimes(data) {
      const grid = document.getElementById("prayerGrid");
      const sunPanel = document.getElementById("sunPanel");

      const prayers = [
        { key: "Fajr", label: "Bomdod", icon: "ğŸŒ…" },
        { key: "Dhuhr", label: "Peshin", icon: "â˜€ï¸" },
        { key: "Asr", label: "Asr", icon: "ğŸŒ¤ï¸" },
        { key: "Maghrib", label: "Shom", icon: "ğŸŒ‡" },
        { key: "Isha", label: "Xufton", icon: "ğŸŒ™" },
      ];

      grid.innerHTML = "";
      prayers.forEach(p => {
        const time = data.timings[p.key];
        const card = document.createElement("div");
        card.className = "prayer-card";
        card.innerHTML = `
          <div class="icon">${p.icon}</div>
          <div class="time">${time}</div>
          <div class="label">${p.label}</div>
        `;
        grid.appendChild(card);
      });

      // Sunrise and Sunset info
      sunPanel.innerHTML = `
        <div class="sun-info">
          <div class="icon">ğŸŒ‡</div>
          <div>
            <span class="sun-label">Quyosh botishi</span>
            <span class="sun-time">${data.timings.Sunset}</span>
          </div>
        </div>
        <div class="sun-info">
          <div class="icon">ğŸŒ…</div>
          <div>
            <span class="sun-label">Quyosh chiqishi</span>
            <span class="sun-time">${data.timings.Sunrise}</span>
          </div>
        </div>
      `;
    }

    async function init() {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const city = await getCityName(lat, lon);
        document.getElementById("cityName").innerText = city;
        document.getElementById("uzbekDate").innerText = getUzbekDate();

        const data = await getPrayerTimes(lat, lon);
        renderPrayerTimes(data);
      }, () => {
        Telegram.WebApp.showAlert("âŒ Lokatsiyani olish imkoni boâ€˜lmadi. Iltimos, ruxsat bering.");
      });
    }

    init();
  </script>
</body>
</html>
