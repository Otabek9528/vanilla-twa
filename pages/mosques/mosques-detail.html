<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Masjid Ma'lumotlari</title>
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="stylesheet" href="mosques.css" />
  <style>
    /* Detail Page Specific Styles */
    .detail-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 20px 16px 40px 16px;
      max-width: 680px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* Loading State */
    .detail-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      gap: 20px;
    }

    .detail-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #e0e0e0;
      border-top-color: #00a884;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .detail-loading p {
      font-size: 1.1rem;
      color: #666;
      margin: 0;
    }

    /* Error State */
    .detail-error {
      text-align: center;
      padding: 80px 20px;
    }

    .detail-error-icon {
      font-size: 4rem;
      margin: 0 0 20px 0;
    }

    .detail-error-text {
      font-size: 1.3rem;
      font-weight: 600;
      color: #d32f2f;
      margin: 0 0 12px 0;
    }

    .detail-error-hint {
      font-size: 1rem;
      color: #666;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .retry-button {
      background: linear-gradient(135deg, #00a884 0%, #007b5e 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 168, 132, 0.3);
    }

    .retry-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0, 168, 132, 0.4);
    }

    .retry-button:active {
      transform: translateY(0);
    }

    /* Detail Card */
    .detail-card {
      background: #ffffff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    /* Photo Section with Carousel */
    .detail-photo-section {
      position: relative;
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, #e8f5f0 0%, #f0f9f5 100%);
    }

    /* Combined Badge on Photo - Single Eye */
    .detail-badges {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .detail-combined-badge {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 12px 18px;
      border-radius: 28px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      gap: 12px;
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    .badge-stars {
      display: flex;
      align-items: center;
      gap: 4px;
      padding-right: 12px;
      border-right: 2px solid rgba(0, 168, 132, 0.2);
    }

    .badge-distance {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #00a884;
      font-weight: 700;
      font-size: 1rem;
    }

    /* Content Section */
    .detail-content {
      padding: 24px;
    }

    .detail-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #2c5e2e;
      margin: 0 0 8px 0;
      line-height: 1.3;
    }

    .detail-subtitle {
      font-size: 1.1rem;
      color: #666;
      margin: 0 0 24px 0;
      font-weight: 500;
    }

    /* Info Section */
    .detail-section {
      margin-bottom: 28px;
    }

    .detail-section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2c5e2e;
      margin: 0 0 14px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-info-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .detail-icon {
      font-size: 1.3rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .detail-text {
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
      flex: 1;
    }

    .detail-link {
      color: #00a884;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .detail-link:hover {
      color: #007b5e;
      text-decoration: underline;
    }

    /* Reviews Section */
    .reviews-section {
      margin-top: 28px;
    }

    .review-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #00a884;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .review-rating {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .review-stars {
      color: #ffd700;
      font-size: 1rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .review-date {
      font-size: 0.85rem;
      color: #888;
    }

    .review-text {
      font-size: 1rem;
      color: #444;
      line-height: 1.6;
      margin: 0;
    }

    .no-reviews {
      text-align: center;
      padding: 40px 20px;
      color: #888;
      font-style: italic;
      font-size: 1rem;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .nav-button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .kakao-button {
      background: linear-gradient(135deg, #ffe812 0%, #ffd000 100%);
      color: #3c1e1e;
    }

    .kakao-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(255, 232, 18, 0.4);
    }

    .naver-button {
      background: linear-gradient(135deg, #03c75a 0%, #00b050 100%);
      color: white;
    }

    .naver-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(3, 199, 90, 0.4);
    }

    .nav-icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    /* Responsive */
    @media (max-width: 420px) {
      .detail-photo-section {
        height: 320px;
      }

      .detail-title {
        font-size: 1.4rem;
      }

      .detail-content {
        padding: 20px;
      }

      .nav-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app__header">
    <div class="header-content">
      <img src="../../assets/emblem.jpg" alt="Bot Emblem" class="bot-logo" />
      <h1>Muslim Vegukin Bot</h1>
    </div>
  </header>

  <!-- DETAIL CONTAINER -->
  <div class="detail-container">
    
    <!-- Loading State -->
    <div class="detail-loading" id="detailLoading">
      <div class="detail-spinner"></div>
      <p>Yuklanmoqda...</p>
    </div>

    <!-- Error State -->
    <div class="detail-error" id="detailError" style="display: none;">
      <p class="detail-error-icon">‚ùå</p>
      <p class="detail-error-text">Xatolik yuz berdi</p>
      <p class="detail-error-hint" id="errorMessage">Ma'lumotlarni yuklashda muammo. Iltimos, qaytadan urinib ko'ring.</p>
      <button class="retry-button" onclick="loadMosqueDetail()">Qaytadan urinish</button>
    </div>

    <!-- Content (Hidden until loaded) -->
    <div id="detailContent" style="display: none;"></div>

  </div>

  <!-- IMAGE MODAL -->
  <div class="image-modal" id="imageModal">
    <div class="modal-content">
      <img src="" alt="Full size image" class="modal-image" id="modalImage" />
      <button class="modal-close" id="modalClose">‚úï</button>
      <div class="modal-hint">Yopish uchun bosing</div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../../js/apiConfig.js"></script>
  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    
    try {
      tg.expand();
    } catch (e) {
      console.log('Expand not supported');
    }
    
    // Show back button
    try {
      if (tg.BackButton) {
        tg.BackButton.show();
        tg.onEvent('backButtonClicked', () => {
          window.location.href = "mosques.html";
        });
      }
    } catch (e) {
      console.log('BackButton not supported');
    }

    // DOM Elements
    const detailLoading = document.getElementById('detailLoading');
    const detailError = document.getElementById('detailError');
    const detailContent = document.getElementById('detailContent');
    const errorMessage = document.getElementById('errorMessage');

    // Carousel state
    let carouselInterval = null;

    // ============================================
    // IMAGE MODAL FUNCTIONALITY
    // ============================================
    
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalClose = document.getElementById('modalClose');

    function openImageModal(imageSrc) {
      modalImage.src = imageSrc;
      imageModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      console.log('üñºÔ∏è Opened modal for:', imageSrc);
    }

    function closeImageModal() {
      imageModal.classList.remove('active');
      document.body.style.overflow = '';
      console.log('‚úï Closed modal');
    }

    // Close modal on click anywhere
    imageModal.addEventListener('click', closeImageModal);
    
    // Close button
    modalClose.addEventListener('click', (e) => {
      e.stopPropagation();
      closeImageModal();
    });

    // Escape key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imageModal.classList.contains('active')) {
        closeImageModal();
      }
    });

    /**
     * Get mosque ID from URL
     */
    function getMosqueId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    /**
     * Fetch mosque details from API
     */
    async function fetchMosqueDetail(id) {
      const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.MOSQUE_DETAIL}/${id}`;
      
      console.log('üîç Fetching mosque detail:', url);
      
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          signal: AbortSignal.timeout(API_CONFIG.DEFAULTS.TIMEOUT)
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ API Response:', data);
        
        if (data.success && data.mosque) {
          return data.mosque;
        } else {
          throw new Error('Invalid API response format');
        }
      } catch (error) {
        console.error('‚ùå Error fetching mosque detail:', error);
        throw error;
      }
    }

    /**
     * Check if an image URL exists
     */
    function checkImageExists(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
      });
    }

    /**
     * Discover available photos in a folder
     */
    async function discoverPhotos(photoPath, maxPhotos = 10) {
      const photos = [];
      const extensions = ['jpg', 'jpeg', 'png'];
      const basePath = `../../${photoPath}`;
      
      for (let i = 1; i <= maxPhotos; i++) {
        let photoFound = false;
        
        for (const ext of extensions) {
          const photoUrl = `${basePath}/${i}.${ext}`;
          
          try {
            const exists = await checkImageExists(photoUrl);
            if (exists) {
              photos.push(photoUrl);
              photoFound = true;
              break;
            }
          } catch (e) {
            continue;
          }
        }
        
        if (!photoFound) {
          break;
        }
      }
      
      return photos;
    }

    /**
     * Create photo carousel HTML for detail page
     */
    function createDetailPhotoCarousel(photos) {
      if (!photos || photos.length === 0) {
        return `
          <img src="../../assets/mosque.png" alt="Mosque photo" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="openImageModal(this.src)" />
        `;
      }
      
      if (photos.length === 1) {
        return `
          <img src="${photos[0]}" alt="Mosque photo" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="openImageModal(this.src)" />
        `;
      }
      
      // Multiple photos - create carousel
      let photosHTML = '';
      let dotsHTML = '';
      
      photos.forEach((photo, index) => {
        const positionClass = index === 0 ? 'center' : 
                             index === 1 ? 'right' : 'hidden';
        
        photosHTML += `
          <div class="carousel-photo ${positionClass}" data-index="${index}" data-photo="${photo}">
            <img src="${photo}" alt="Mosque photo ${index + 1}" />
          </div>
        `;
        
        dotsHTML += `
          <span class="dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>
        `;
      });
      
      return `
        <div class="photo-carousel" id="detailCarousel">
          <div class="carousel-track">
            ${photosHTML}
          </div>
          <div class="carousel-dots">
            ${dotsHTML}
          </div>
        </div>
      `;
    }

    /**
     * Initialize carousel for detail page
     */
    function initDetailCarousel(photoCount) {
      const carousel = document.getElementById('detailCarousel');
      if (!carousel || photoCount <= 1) return;
      
      const photos = carousel.querySelectorAll('.carousel-photo');
      const dots = carousel.querySelectorAll('.dot');
      let currentIndex = 0;
      
      function updateCarousel(newIndex) {
        const totalPhotos = photos.length;
        
        photos.forEach((photo, index) => {
          let relativePos = (index - newIndex + totalPhotos) % totalPhotos;
          
          photo.classList.remove('center', 'left', 'right', 'hidden');
          
          if (relativePos === 0) {
            photo.classList.add('center');
          } else if (relativePos === 1) {
            photo.classList.add('right');
          } else if (relativePos === totalPhotos - 1) {
            photo.classList.add('left');
          } else {
            photo.classList.add('hidden');
          }
        });
        
        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === newIndex);
        });
        
        currentIndex = newIndex;
      }
      
      // Photo click handlers - open modal for center photo only
      photos.forEach((photo) => {
        photo.addEventListener('click', (e) => {
          e.stopPropagation();
          
          if (photo.classList.contains('center')) {
            const photoUrl = photo.getAttribute('data-photo');
            openImageModal(photoUrl);
          }
        });
      });
      
      // Dot click handlers
      dots.forEach((dot, index) => {
        dot.addEventListener('click', (e) => {
          e.stopPropagation();
          updateCarousel(index);
          
          if (carouselInterval) {
            clearInterval(carouselInterval);
          }
          startAutoRotation();
        });
      });
      
      // Auto-rotation
      function startAutoRotation() {
        carouselInterval = setInterval(() => {
          const nextIndex = (currentIndex + 1) % photos.length;
          updateCarousel(nextIndex);
        }, 3000);
      }
      
      startAutoRotation();
      
      // Pause on hover
      carousel.addEventListener('mouseenter', () => {
        if (carouselInterval) {
          clearInterval(carouselInterval);
        }
      });
      
      carousel.addEventListener('mouseleave', () => {
        startAutoRotation();
      });
    }

    /**
     * Generate star rating HTML
     */
    function generateStarRating(reviews) {
      if (!reviews || reviews.length === 0) {
        return `<span class="no-rating-text">Sharhlar yo'q</span>`;
      }
      
      const avgRating = reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length;
      const roundedRating = Math.round(avgRating);
      
      let starsHTML = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= roundedRating) {
          starsHTML += `<span class="star gold">‚≠ê</span>`;
        } else {
          starsHTML += `<span class="star grey">‚≠ê</span>`;
        }
      }
      
      return `<div class="star-container">${starsHTML}</div>`;
    }

    /**
     * Format date string
     */
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('uz-UZ', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      } catch (e) {
        return dateString;
      }
    }

    /**
     * Render reviews section
     */
    function renderReviews(reviews) {
      if (!reviews || reviews.length === 0) {
        return '<div class="no-reviews">Hali sharhlar yo\'q</div>';
      }

      let reviewsHTML = '';
      reviews.forEach(review => {
        const stars = '‚≠ê'.repeat(review.rating);
        const date = formatDate(review.timestamp);
        
        reviewsHTML += `
          <div class="review-card">
            <div class="review-header">
              <div class="review-rating">
                <span class="review-stars">${stars}</span>
              </div>
              <span class="review-date">${date}</span>
            </div>
            <p class="review-text">${review.text || 'Sharh matni yo\'q'}</p>
          </div>
        `;
      });

      return reviewsHTML;
    }

    /**
     * Render mosque detail
     */
    async function renderMosqueDetail(mosque) {
      // Discover photos
      const photos = await discoverPhotos(mosque.photo, 10);
      console.log('üì∏ Found photos:', photos.length);
      
      // Create photo carousel HTML
      const photoHTML = createDetailPhotoCarousel(photos);
      
      // Generate star rating
      const starRatingHTML = generateStarRating(mosque.reviews);
      
      // Format phone
      const phoneDisplay = mosque.phone || 'Ma\'lumot yo\'q';
      
      // Render reviews
      const reviewsHTML = renderReviews(mosque.reviews);
      const reviewCount = mosque.reviews ? mosque.reviews.length : 0;
      
      // Format distance
      const distanceDisplay = mosque.distance ? mosque.distance.toFixed(1) : 'N/A';
      
      detailContent.innerHTML = `
        <div class="detail-card">
          <!-- Photo Section with Carousel -->
          <div class="detail-photo-section">
            <!-- Combined Badge on Photo (Single Eye) -->
            <div class="detail-badges">
              <div class="detail-combined-badge">
                <div class="badge-stars">
                  ${starRatingHTML}
                </div>
                ${mosque.distance ? `
                  <div class="badge-distance">
                    <span>üìç</span>
                    <span>${distanceDisplay} km</span>
                  </div>
                ` : ''}
              </div>
            </div>
            
            ${photoHTML}
          </div>
          
          <!-- Content Section -->
          <div class="detail-content">
            <h1 class="detail-title">${mosque.name}</h1>
            <p class="detail-subtitle">${mosque.city || 'Unknown City'}</p>
            
            <!-- Contact Info -->
            <div class="detail-section">
              <h3 class="detail-section-title">üìû Kontakt</h3>
              <div class="detail-info-item">
                <span class="detail-icon">üì±</span>
                ${mosque.phone ? `<a href="tel:${mosque.phone}" class="detail-link">${phoneDisplay}</a>` : `<span class="detail-text">${phoneDisplay}</span>`}
              </div>
            </div>
            
            <!-- Address -->
            <div class="detail-section">
              <h3 class="detail-section-title">üìç Manzil</h3>
              <div class="detail-info-item">
                <span class="detail-icon">üåê</span>
                <span class="detail-text">${mosque.address || 'Manzil ma\'lumoti yo\'q'}</span>
              </div>
            </div>
            
            <!-- Reviews -->
            ${reviewCount > 0 ? `
              <div class="detail-section reviews-section">
                <h3 class="detail-section-title">üí¨ Sharhlar (${reviewCount})</h3>
                ${reviewsHTML}
              </div>
            ` : ''}
            
            <!-- Navigation Buttons -->
            <div class="detail-section">
              <h3 class="detail-section-title">üó∫Ô∏è Navigatsiya</h3>
              <div class="nav-buttons">
                ${mosque.kakaoMapUrl ? `
                  <a href="${mosque.kakaoMapUrl}" target="_blank" class="nav-button kakao-button">
                    <span class="nav-icon">üü°</span>
                    <span>KakaoMap</span>
                  </a>
                ` : ''}
                ${mosque.naverMapUrl ? `
                  <a href="${mosque.naverMapUrl}" target="_blank" class="nav-button naver-button">
                    <span class="nav-icon">üü¢</span>
                    <span>NaverMap</span>
                  </a>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Initialize carousel if multiple photos
      if (photos.length > 1) {
        initDetailCarousel(photos.length);
      }
    }

    /**
     * Show error state
     */
    function showError(message) {
      detailLoading.style.display = 'none';
      detailContent.style.display = 'none';
      detailError.style.display = 'block';
      errorMessage.textContent = message;
    }

    /**
     * Load and display mosque detail
     */
    async function loadMosqueDetail() {
      const mosqueId = getMosqueId();
      
      if (!mosqueId) {
        showError('Masjid ID topilmadi. Iltimos, orqaga qaytib, qaytadan tanlang.');
        return;
      }

      console.log('üì± Loading mosque detail for ID:', mosqueId);
      
      // Show loading state
      detailLoading.style.display = 'flex';
      detailError.style.display = 'none';
      detailContent.style.display = 'none';
      
      try {
        // Fetch mosque from API
        const mosque = await fetchMosqueDetail(mosqueId);
        
        // Hide loading
        detailLoading.style.display = 'none';
        
        // Show content
        detailContent.style.display = 'block';
        
        // Render mosque
        await renderMosqueDetail(mosque);
        
        console.log('‚úÖ Mosque detail loaded successfully');
        
      } catch (error) {
        console.error('‚ùå Error loading mosque detail:', error);
        
        let errorMsg = 'Ma\'lumotlarni yuklashda xatolik yuz berdi. Iltimos, internetni tekshirib, qaytadan urinib ko\'ring.';
        
        if (error.name === 'TimeoutError') {
          errorMsg = 'Server javob bermadi (30 soniya). Server uyg\'onayotgan bo\'lishi mumkin, iltimos 1 daqiqa kuting va qaytadan urinib ko\'ring.';
        } else if (error.message.includes('404')) {
          errorMsg = 'Masjid topilmadi. Bu masjid bazadan o\'chirilgan bo\'lishi mumkin.';
        }
        
        showError(errorMsg);
      }
    }

    // Load detail when page loads
    document.addEventListener('DOMContentLoaded', loadMosqueDetail);
  </script>

</body>
</html>